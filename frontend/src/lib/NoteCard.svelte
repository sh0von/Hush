<script>
  import axios from "axios";
  import { onMount } from "svelte";
  import { API_URL } from "$lib/Api.js";

  export let avatarSrc;
  export let username;
  export let message;
  export let postInfo;
  export let loveCount;
  export let messageId;
  export let isMostLoved = false;

  let isLoved = false;

  const localStorageKey = `isLoved_${messageId}`;
  const storedIsLoved = localStorage.getItem(localStorageKey);
  if (storedIsLoved !== null) {
    isLoved = JSON.parse(storedIsLoved);
  }

  async function increaseLove() {
    try {
      if (isLoved) {
        return;
      }

      const response = await axios.put(`${API_URL}/messages/${messageId}/love`);
      loveCount = response.data.loveCount;
      isLoved = true;

      localStorage.setItem(localStorageKey, JSON.stringify(true));
    } catch (error) {
      console.error("Error increasing love:", error);
    }
  }

  onMount(async () => {
    try {
      const response = await axios.get(`${API_URL}/messages/${messageId}/love`);
      isLoved = response.data.isLoved;
    } catch (error) {
      console.error("Error fetching love status:", error);
    }
  });
</script>

<div
  class="relative note-card w-full pixel rounded-lg shadow-md p-6 hover:shadow-lg transition-all duration-300"
>
  <div class="flex items-center justify-between mb-2">
    <div class="flex items-center">
      <img src={avatarSrc} class="w-8 h-8 rounded-full mr-2" alt="Avatar" />
      <span class="font-semibold text-white">{username}</span>
      {#if isMostLoved}
        <svg
          style="padding-left: 10px;"
          height="50px"
          width="50px"
          version="1.1"
          id="Layer_1"
          xmlns="http://www.w3.org/2000/svg"
          xmlns:xlink="http://www.w3.org/1999/xlink"
          viewBox="0 0 512.042 512.042"
          xml:space="preserve"
        >
          <g transform="translate(1 1)">
            <path
              style="fill:#FFFFFF;"
              d="M94.055,237.101L33.468,84.354h-25.6l60.587,152.747c9.387,24.747,27.307,45.227,50.347,57.173
          c2.56,1.707,5.12,2.56,7.68,3.413v-15.36C112.828,270.381,101.735,255.021,94.055,237.101"
            />
            <path
              style="fill:#FD9808;"
              d="M477.201,84.354l-60.587,152.747c-7.68,17.92-18.773,33.28-33.28,46.08v14.507
          c2.56-0.853,5.12-2.56,7.68-3.413c23.04-11.947,40.96-33.28,50.347-57.173l61.44-152.747H477.201z"
            />
            <g>
              <path
                style="fill:#FFDD09;"
                d="M374.801,84.354l-34.133,51.2h-17.067v34.133h-8.533v128c45.227-0.853,57.173,1.707,59.733,0
            c23.04-11.947,31.573-36.693,41.813-60.587l60.587-152.747H374.801z"
              />
              <path
                style="fill:#FFDD09;"
                d="M187.068,169.688L187.068,169.688v-34.133h-17.067l-34.133-51.2h-102.4l60.587,152.747
            c9.387,24.747,26.453,48.64,50.347,60.587c2.56,1.707,5.973-0.853,42.667,0V169.688z"
              />
              <polygon
                style="fill:#FFDD09;"
                points="255.335,425.688 101.735,135.554 408.935,135.554 		"
              />
            </g>
            <polygon
              style="fill:#54C9FD;"
              points="158.055,169.688 352.615,169.688 255.335,353.154 	"
            />
            <g>
              <path
                style="fill:#110E0E;"
                d="M255.335,434.221c-3.413,0-5.973-1.707-7.68-4.267l-153.6-290.133c-1.707-2.56-1.707-5.973,0-8.533
            s4.267-4.267,7.68-4.267h307.2c3.413,0,5.973,1.707,7.68,4.267c1.707,2.56,1.707,5.973,0,8.533l-153.6,290.133
            C261.308,432.514,258.748,434.221,255.335,434.221z M116.241,144.088l139.093,263.68l139.093-263.68H116.241z"
              />
              <path
                style="fill:#110E0E;"
                d="M255.335,361.688c-3.413,0-5.973-1.707-7.68-4.267l-96.427-183.467
            c-1.707-2.56-1.707-5.973,0-8.533c1.707-2.56,4.267-4.267,6.827-4.267h193.707c3.413,0,5.973,1.707,7.68,4.267
            c1.707,2.56,1.707,5.973,0,8.533l-96.427,183.467C261.308,359.981,258.748,361.688,255.335,361.688z M172.561,178.221
            l82.773,156.16l82.773-156.16H172.561z"
              />
            </g>
            <path
              d="M67.601,127.021h-46.08c-5.12,0-8.533-3.413-8.533-8.533c0-5.12,3.413-8.533,8.533-8.533h46.08
          c5.12,0,8.533,3.413,8.533,8.533C76.135,123.608,72.721,127.021,67.601,127.021z"
            />
            <path
              d="M76.135,161.154h-40.96c-5.12,0-8.533-3.413-8.533-8.533c0-5.12,3.413-8.533,8.533-8.533h40.96
          c5.12,0,8.533,3.413,8.533,8.533C84.668,157.741,81.255,161.154,76.135,161.154z"
            />
            <path
              d="M93.201,195.288H48.828c-5.12,0-8.533-3.413-8.533-8.533c0-5.12,3.413-8.533,8.533-8.533h44.373
          c5.12,0,8.533,3.413,8.533,8.533C101.735,191.874,98.321,195.288,93.201,195.288z"
            />
            <path
              d="M489.148,127.021h-46.08c-5.12,0-8.533-3.413-8.533-8.533c0-5.12,3.413-8.533,8.533-8.533h46.08
          c5.12,0,8.533,3.413,8.533,8.533C497.681,123.608,494.268,127.021,489.148,127.021z"
            />
            <path
              d="M475.495,161.154h-40.96c-5.12,0-8.533-3.413-8.533-8.533c0-5.12,3.413-8.533,8.533-8.533h40.96
          c5.12,0,8.533,3.413,8.533,8.533C484.028,157.741,480.615,161.154,475.495,161.154z"
            />
            <path
              d="M461.841,195.288h-44.373c-5.12,0-8.533-3.413-8.533-8.533c0-5.12,3.413-8.533,8.533-8.533h44.373
          c5.12,0,8.533,3.413,8.533,8.533C470.375,191.874,466.961,195.288,461.841,195.288z"
            />
            <path
              d="M187.921,306.221h-35.84c-29.013,0-56.32-12.8-74.24-35.84c-2.56-3.413-2.56-9.387,1.707-11.947
          c3.413-2.56,9.387-2.56,11.947,1.707c15.36,18.773,37.547,29.013,61.44,29.013h21.333L94.055,139.821
          c-1.707-2.56-1.707-5.973,0-8.533s4.267-4.267,7.68-4.267h52.053l-23.04-34.133H19.815l46.933,116.053
          c1.707,4.267,0,9.387-5.12,11.093c-4.267,1.707-9.387,0-11.093-5.12l-51.2-128c-0.853-1.707,0-5.12,1.707-6.827
          c1.707-1.707,4.267-4.267,6.827-4.267h128c2.56,0,5.12,1.707,6.827,3.413l34.133,51.2c1.707,2.56,1.707,5.973,0,8.533
          c-0.853,3.413-3.413,5.12-6.827,5.12h-53.76l79.36,149.333c1.707,2.56,1.707,5.973,0,8.533
          C193.041,304.514,190.481,306.221,187.921,306.221z"
            />
            <path
              d="M358.588,306.221h-35.84c-3.413,0-5.973-1.707-7.68-4.267s-1.707-5.973,0-8.533l79.36-149.333h-53.76
          c-3.413,0-5.973-1.707-7.68-4.267c-1.707-2.56-1.707-5.973,0-8.533l34.133-51.2c2.56-2.56,5.12-4.267,7.68-4.267h128
          c2.56,0,5.12,1.707,6.827,3.413c1.707,2.56,1.707,5.12,0.853,7.68l-63.147,159.573c-3.413,8.533-8.533,17.067-14.507,23.893
          C414.908,293.421,387.601,306.221,358.588,306.221z M337.255,289.154h21.333c23.893,0,46.08-11.093,61.44-29.013
          c5.12-5.973,8.533-12.8,11.947-19.627l58.027-147.627H379.068l-23.04,34.133h52.907c3.413,0,5.973,1.707,7.68,4.267
          c1.707,2.56,1.707,5.973,0,8.533L337.255,289.154z"
            />
            <path
              d="M79.548,238.808c0-5.12-3.413-8.533-8.533-8.533c-5.12,0-8.533,3.413-8.533,8.533c0,5.12,3.413,8.533,8.533,8.533
          C76.135,247.341,79.548,243.074,79.548,238.808"
            />
          </g>
        </svg>
      {/if}
    </div>
    <div
      class="flex items-center"
      on:click={increaseLove}
      style="cursor: pointer;"
    >
      {#if isLoved}
        <svg
          class="w-6 h-6 fill-current text-green-500 mr-2"
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 24 24"
        >
          <path
            d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"
          />
        </svg>
      {:else}
        <svg
          class="w-6 h-6 fill-current text-white mr-2"
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 24 24"
        >
          <path
            d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"
          />
        </svg>
      {/if}
      <span class="text-white">{loveCount}</span>
    </div>
  </div>
  <hr class="py-2" />
  <p class="text-white mb-4">{message}</p>
  <small class="text-white">{postInfo}</small>
</div>
